<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Indicadores RH</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .tab-btn:hover, .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 12px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #a0a0a0;
        }
        
        .filter-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9em;
        }
        
        .filter-group select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .metric-card.alt {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .metric-card.green {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #a0a0a0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        th {
            background: rgba(255,255,255,0.1);
            font-weight: 600;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .table-container {
            overflow-x: auto;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #a0a0a0;
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Dashboard de Indicadores - Gest√£o de Vagas</h1>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('vagas')">üéØ Vagas Trabalhadas</button>
            <button class="tab-btn" onclick="showTab('desligamentos')">üö™ Motivos de Desligamento</button>
            <button class="tab-btn" onclick="showTab('tempos')">‚è±Ô∏è Tempo M√©dio de Fechamento</button>
        </div>

        <!-- TAB 1: VAGAS TRABALHADAS -->
        <div id="vagas" class="tab-content active">
            <div class="filters">
                <div class="filter-group">
                    <label>Filtrar por M√™s:</label>
                    <select id="filtro-mes-vagas" multiple></select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por Status:</label>
                    <select id="filtro-status-vagas" multiple></select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por N√≠vel:</label>
                    <select id="filtro-nivel-vagas" multiple></select>
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end;">
                    <button class="tab-btn" onclick="atualizarVagas()">Aplicar Filtros</button>
                </div>
            </div>

            <h2 class="section-title">üìà Resumo por N√≠vel</h2>
            <div id="metrics-vagas" class="metrics"></div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Por N√≠vel</h3>
                    <div class="chart-container">
                        <canvas id="chart-nivel"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Por Linha de Cuidado</h3>
                    <div class="chart-container">
                        <canvas id="chart-linha"></canvas>
                    </div>
                </div>
            </div>

            <h2 class="section-title">üìã Detalhamento: Vagas por Linha de Cuidado e N√≠vel</h2>
            <div class="table-container">
                <table id="tabela-cruzada">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- TAB 2: MOTIVOS DE DESLIGAMENTO -->
        <div id="desligamentos" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>Filtrar por M√™s:</label>
                    <select id="filtro-mes-desl" multiple></select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por Linha de Cuidado:</label>
                    <select id="filtro-linha-desl" multiple></select>
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end;">
                    <button class="tab-btn" onclick="atualizarDesligamentos()">Aplicar Filtros</button>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üöë Urg√™ncia e Emerg√™ncia</h3>
                    <div class="chart-container">
                        <canvas id="chart-ue"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üè• Aten√ß√£o Prim√°ria (APS)</h3>
                    <div class="chart-container">
                        <canvas id="chart-aps"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card" style="margin-top: 20px;">
                <h3>üìä Top 5 Motivos Gerais</h3>
                <div class="chart-container">
                    <canvas id="chart-top5"></canvas>
                </div>
            </div>
        </div>

        <!-- TAB 3: TEMPO M√âDIO -->
        <div id="tempos" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>Filtrar por M√™s:</label>
                    <select id="filtro-mes-tempo" multiple></select>
                </div>
                <div class="filter-group">
                    <label>Filtrar por Linha de Cuidado:</label>
                    <select id="filtro-linha-tempo" multiple></select>
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end;">
                    <button class="tab-btn" onclick="atualizarTempos()">Aplicar Filtros</button>
                </div>
            </div>

            <h2 class="section-title">‚è±Ô∏è Indicadores de Tempo</h2>
            <div id="metrics-tempo" class="metrics"></div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìä Tempo M√©dio de Sele√ß√£o por Linha de Cuidado</h3>
                    <div class="chart-container">
                        <canvas id="chart-tempo-sel"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>üìä Tempo M√©dio de Admiss√£o por Linha de Cuidado</h3>
                    <div class="chart-container">
                        <canvas id="chart-tempo-adm"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card" style="margin-top: 20px;">
                <h3>üìà Evolu√ß√£o Mensal do Tempo de Fechamento</h3>
                <div class="chart-container">
                    <canvas id="chart-evolucao"></canvas>
                </div>
            </div>
        </div>

        <footer>
            üìä Dashboard de Indicadores RH | Fonte: Pasta1.xlsx
        </footer>
    </div>

    <script>
        let charts = {};
        let filtrosData = {};

        const cores = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
            '#fee140', '#30cfd0', '#a8edea', '#ff9a9e', '#ffecd2',
            '#764ba2', '#f5576c'
        ];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarFiltros();
            await atualizarVagas();
            await atualizarDesligamentos();
            await atualizarTempos();
        });

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        async function carregarFiltros() {
            const response = await fetch('/api/filtros');
            filtrosData = await response.json();

            // Preencher selects de m√™s
            ['filtro-mes-vagas', 'filtro-mes-desl', 'filtro-mes-tempo'].forEach(id => {
                const select = document.getElementById(id);
                filtrosData.meses.forEach(mes => {
                    const option = document.createElement('option');
                    option.value = mes;
                    option.text = mes;
                    option.selected = true;
                    select.appendChild(option);
                });
            });

            // Status
            const statusSelect = document.getElementById('filtro-status-vagas');
            filtrosData.status.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.text = s;
                option.selected = true;
                statusSelect.appendChild(option);
            });

            // N√≠veis
            const nivelSelect = document.getElementById('filtro-nivel-vagas');
            filtrosData.niveis.forEach(n => {
                const option = document.createElement('option');
                option.value = n;
                option.text = n;
                option.selected = true;
                nivelSelect.appendChild(option);
            });

            // Linhas de cuidado
            ['filtro-linha-desl', 'filtro-linha-tempo'].forEach(id => {
                const select = document.getElementById(id);
                filtrosData.linhas_cuidado.forEach(lc => {
                    const option = document.createElement('option');
                    option.value = lc;
                    option.text = lc;
                    option.selected = true;
                    select.appendChild(option);
                });
            });
        }

        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.selectedOptions).map(o => o.value);
        }

        async function atualizarVagas() {
            const meses = getSelectedValues('filtro-mes-vagas');
            const status = getSelectedValues('filtro-status-vagas');
            const niveis = getSelectedValues('filtro-nivel-vagas');

            const params = new URLSearchParams();
            meses.forEach(m => params.append('mes', m));
            status.forEach(s => params.append('status', s));
            niveis.forEach(n => params.append('nivel', n));

            const response = await fetch(`/api/vagas?${params}`);
            const data = await response.json();

            // M√©tricas
            let metricsHtml = '';
            Object.entries(data.por_nivel).forEach(([nivel, qtd], i) => {
                if (nivel !== 'N√£o Classificado') {
                    metricsHtml += `
                        <div class="metric-card ${i % 2 === 0 ? '' : 'alt'}">
                            <div class="metric-value">${qtd}</div>
                            <div class="metric-label">${nivel}</div>
                        </div>
                    `;
                }
            });
            metricsHtml += `
                <div class="metric-card green">
                    <div class="metric-value">${data.total}</div>
                    <div class="metric-label">TOTAL GERAL</div>
                </div>
            `;
            document.getElementById('metrics-vagas').innerHTML = metricsHtml;

            // Gr√°fico por n√≠vel
            const nivelLabels = Object.keys(data.por_nivel).filter(k => k !== 'N√£o Classificado');
            const nivelValues = nivelLabels.map(k => data.por_nivel[k]);
            
            if (charts.nivel) charts.nivel.destroy();
            charts.nivel = new Chart(document.getElementById('chart-nivel'), {
                type: 'doughnut',
                data: {
                    labels: nivelLabels,
                    datasets: [{
                        data: nivelValues,
                        backgroundColor: cores
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });

            // Gr√°fico por linha de cuidado
            const linhaLabels = Object.keys(data.por_linha_cuidado);
            const linhaValues = Object.values(data.por_linha_cuidado);
            
            if (charts.linha) charts.linha.destroy();
            charts.linha = new Chart(document.getElementById('chart-linha'), {
                type: 'doughnut',
                data: {
                    labels: linhaLabels,
                    datasets: [{
                        data: linhaValues,
                        backgroundColor: cores
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#fff' }
                        }
                    }
                }
            });

            // Tabela cruzada
            const tabela = data.tabela_cruzada;
            const linhas = Object.keys(tabela);
            const colunas = linhas.length > 0 ? Object.keys(tabela[linhas[0]]) : [];

            let theadHtml = '<tr><th>Linha de Cuidado</th>';
            colunas.forEach(col => theadHtml += `<th>${col}</th>`);
            theadHtml += '</tr>';

            let tbodyHtml = '';
            linhas.forEach(linha => {
                tbodyHtml += `<tr><td>${linha}</td>`;
                colunas.forEach(col => tbodyHtml += `<td>${tabela[linha][col] || 0}</td>`);
                tbodyHtml += '</tr>';
            });

            document.querySelector('#tabela-cruzada thead').innerHTML = theadHtml;
            document.querySelector('#tabela-cruzada tbody').innerHTML = tbodyHtml;
        }

        async function atualizarDesligamentos() {
            const meses = getSelectedValues('filtro-mes-desl');
            const linhas = getSelectedValues('filtro-linha-desl');

            const params = new URLSearchParams();
            meses.forEach(m => params.append('mes', m));
            linhas.forEach(l => params.append('linha', l));

            const response = await fetch(`/api/desligamentos?${params}`);
            const data = await response.json();

            // Gr√°fico Urg√™ncia/Emerg√™ncia
            if (charts.ue) charts.ue.destroy();
            charts.ue = new Chart(document.getElementById('chart-ue'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.urgencia_emergencia),
                    datasets: [{
                        data: Object.values(data.urgencia_emergencia),
                        backgroundColor: '#f5576c'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { display: false } }
                    }
                }
            });

            // Gr√°fico APS
            if (charts.aps) charts.aps.destroy();
            charts.aps = new Chart(document.getElementById('chart-aps'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.aps),
                    datasets: [{
                        data: Object.values(data.aps),
                        backgroundColor: '#4facfe'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { display: false } }
                    }
                }
            });

            // Top 5
            if (charts.top5) charts.top5.destroy();
            charts.top5 = new Chart(document.getElementById('chart-top5'), {
                type: 'bar',
                data: {
                    labels: Object.keys(data.top5_geral),
                    datasets: [{
                        data: Object.values(data.top5_geral),
                        backgroundColor: cores
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        async function atualizarTempos() {
            const meses = getSelectedValues('filtro-mes-tempo');
            const linhas = getSelectedValues('filtro-linha-tempo');

            const params = new URLSearchParams();
            meses.forEach(m => params.append('mes', m));
            linhas.forEach(l => params.append('linha', l));

            const response = await fetch(`/api/tempos?${params}`);
            const data = await response.json();

            // M√©tricas
            document.getElementById('metrics-tempo').innerHTML = `
                <div class="metric-card">
                    <div class="metric-value">${data.media_selecao} dias</div>
                    <div class="metric-label">Tempo M√©dio em Sele√ß√£o</div>
                </div>
                <div class="metric-card alt">
                    <div class="metric-value">${data.media_admissao} dias</div>
                    <div class="metric-label">Tempo M√©dio em Admiss√£o</div>
                </div>
                <div class="metric-card green">
                    <div class="metric-value">${data.media_total} dias</div>
                    <div class="metric-label">Tempo Total M√©dio</div>
                </div>
            `;

            // Gr√°fico tempo sele√ß√£o
            const linhasSel = Object.keys(data.por_linha_selecao).filter(k => k !== 'N√£o Classificado');
            if (charts.tempoSel) charts.tempoSel.destroy();
            charts.tempoSel = new Chart(document.getElementById('chart-tempo-sel'), {
                type: 'bar',
                data: {
                    labels: linhasSel,
                    datasets: [{
                        data: linhasSel.map(l => data.por_linha_selecao[l]),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#fff', maxRotation: 45 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Gr√°fico tempo admiss√£o
            const linhasAdm = Object.keys(data.por_linha_admissao).filter(k => k !== 'N√£o Classificado');
            if (charts.tempoAdm) charts.tempoAdm.destroy();
            charts.tempoAdm = new Chart(document.getElementById('chart-tempo-adm'), {
                type: 'bar',
                data: {
                    labels: linhasAdm,
                    datasets: [{
                        data: linhasAdm.map(l => data.por_linha_admissao[l]),
                        backgroundColor: '#f093fb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#fff', maxRotation: 45 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });

            // Evolu√ß√£o mensal
            const periodos = Object.keys(data.evolucao_mensal).sort();
            if (charts.evolucao) charts.evolucao.destroy();
            charts.evolucao = new Chart(document.getElementById('chart-evolucao'), {
                type: 'line',
                data: {
                    labels: periodos,
                    datasets: [
                        {
                            label: 'Sele√ß√£o',
                            data: periodos.map(p => data.evolucao_mensal[p]['Tempo Sele√ß√£o (dias)']),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Admiss√£o',
                            data: periodos.map(p => data.evolucao_mensal[p]['Tempo Admiss√£o (dias)']),
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.2)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }
    </script>
</body>
</html>